#include "module.h"
#include "moduleplacement.h"
#include "test_module.h"
#include <assert.h>
#include <stdio.h>
#include <stdlib.h>

static void test_getSymbolSizeInNumModules(void) {
    assert(getSymbolSizeInNumModules(1) == 21);
    assert(getSymbolSizeInNumModules(2) == 25);
    assert(getSymbolSizeInNumModules(3) == 29);
    assert(getSymbolSizeInNumModules(40) == 177);

    printf("test_getSymbolSizeInNumModules() passed\n");
}

static void test_placeFunctionPatterns(void) {
    size_t symbolSize = 45;
    uint8_t *matrix = malloc(symbolSize * symbolSize * sizeof(uint8_t));

    const uint8_t codewords[196] = {0};

    placeModules(matrix, symbolSize, 7, codewords);

    const uint8_t *expected =
        (const uint8_t *)"555555546000000000000000000000000066645555555"
                         "544444546000000000000000000000000066645444445"
                         "545554546000000000000000000000000066645455545"
                         "545554546000000000000000000000000066645455545"
                         "545554546000000000005555500000000066645455545"
                         "544444546000000000005444500000000066645444445"
                         "555555545454545454545454545454545454545555555"
                         "444444446000000000005444500000000000044444444"
                         "666666566000000000005555500000000000066666666"
                         "000000400000000000000000000000000000000000000"
                         "000000500000000000000000000000000000000000000"
                         "000000400000000000000000000000000000000000000"
                         "000000500000000000000000000000000000000000000"
                         "000000400000000000000000000000000000000000000"
                         "000000500000000000000000000000000000000000000"
                         "000000400000000000000000000000000000000000000"
                         "000000500000000000000000000000000000000000000"
                         "000000400000000000000000000000000000000000000"
                         "000000500000000000000000000000000000000000000"
                         "000000400000000000000000000000000000000000000"
                         "000055555000000000005555500000000000555550000"
                         "000054445000000000005444500000000000544450000"
                         "000054545000000000005454500000000000545450000"
                         "000054445000000000005444500000000000544450000"
                         "000055555000000000005555500000000000555550000"
                         "000000400000000000000000000000000000000000000"
                         "000000500000000000000000000000000000000000000"
                         "000000400000000000000000000000000000000000000"
                         "000000500000000000000000000000000000000000000"
                         "000000400000000000000000000000000000000000000"
                         "000000500000000000000000000000000000000000000"
                         "000000400000000000000000000000000000000000000"
                         "000000500000000000000000000000000000000000000"
                         "000000400000000000000000000000000000000000000"
                         "666666500000000000000000000000000000000000000"
                         "666666400000000000000000000000000000000000000"
                         "666666500000000000005555500000000000555550000"
                         "444444445000000000005444500000000000544450000"
                         "555555546000000000005454500000000000545450000"
                         "544444546000000000005444500000000000544450000"
                         "545554546000000000005555500000000000555550000"
                         "545554546000000000000000000000000000000000000"
                         "545554546000000000000000000000000000000000000"
                         "544444546000000000000000000000000000000000000"
                         "555555546000000000000000000000000000000000000";

    matrixEquals(matrix, expected, symbolSize);

    printf("test_placeFunctionPatterns() passed\n");
}

static void test_placeCodewordModules(void) {
    size_t symbolSize = 21;
    uint8_t *matrix = malloc(symbolSize * symbolSize * sizeof(uint8_t));

    uint8_t codewords[] = {0x10, 0x20, 0x0C, 0x56, 0x61, 0x80, 0xEC,
                           0x11, 0xEC, 0x11, 0xEC, 0x11, 0xEC, 0x11,
                           0xEC, 0x11, 0xA5, 0x24, 0xD4, 0xC1, 0xED,
                           0x36, 0xC7, 0x87, 0x2C, 0x55, 0x00};

    placeModules(matrix, symbolSize, 1, codewords);

    const uint8_t *expected = (const uint8_t *)"555555546001045555555"
                                               "544444546011045444445"
                                               "545554546100145455545"
                                               "545554546000145455545"
                                               "545554546111045455545"
                                               "544444546100045444445"
                                               "555555545454545555555"
                                               "444444446101044444444"
                                               "666666566000066666666"
                                               "100001411110000001000"
                                               "101100510001110111011"
                                               "100110400000100011000"
                                               "100011511101110110100"
                                               "444444445111011101000"
                                               "555555546010001000100"
                                               "544444546111011100001"
                                               "545554546100000001000"
                                               "545554546000000000100"
                                               "545554546111110110000"
                                               "544444546100100010010"
                                               "555555546011110110000";

    matrixEquals(matrix, expected, symbolSize);

    printf("test_placeCodewordModules() passed\n");
}

int main(void) {
    test_getSymbolSizeInNumModules();
    test_placeFunctionPatterns();
    test_placeCodewordModules();

    return 0;
}
