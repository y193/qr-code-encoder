#include "datamasking.h"
#include "module.h"
#include "test_module.h"
#include <assert.h>
#include <stdio.h>
#include <stdlib.h>

static void test_applyDataMaskPatternN(unsigned int pattern,
                                       const uint8_t *expected) {
    size_t symbolSize = 21;

    uint8_t *unmasked = malloc(symbolSize * symbolSize * sizeof(uint8_t));
    uint8_t *masked = malloc(symbolSize * symbolSize * sizeof(uint8_t));

    const uint8_t *input = (const uint8_t *)"555555546000045555555"
                                            "544444546000045444445"
                                            "545554546000045455545"
                                            "545554546000045455545"
                                            "545554546000045455545"
                                            "544444546000045444445"
                                            "555555545454545555555"
                                            "444444446000044444444"
                                            "666666566000066666666"
                                            "000000400000000000000"
                                            "000000500000000000000"
                                            "000000400000000000000"
                                            "000000500000000000000"
                                            "444444445000000000000"
                                            "555555546000000000000"
                                            "544444546000000000000"
                                            "545554546000000000000"
                                            "545554546000000000000"
                                            "545554546000000000000"
                                            "544444546000000000000"
                                            "555555546000000000000";

    initializeMatrix(unmasked, input, symbolSize);

    applyDataMaskPattern(masked, unmasked, symbolSize, pattern);

    matrixEquals(masked, expected, symbolSize);

    printf("test_applyDataMaskPattern%u() passed\n", pattern);
}

static void test_applyDataMaskPattern0(void) {
    const uint8_t *expected = (const uint8_t *)"111111102010101111111"
                                               "100000102101001000001"
                                               "101110102010101011101"
                                               "101110102101001011101"
                                               "101110102010101011101"
                                               "100000102101001000001"
                                               "111111101010101111111"
                                               "000000002101000000000"
                                               "222222122010122222222"
                                               "010101010101010101010"
                                               "101010101010101010101"
                                               "010101010101010101010"
                                               "101010101010101010101"
                                               "000000001101010101010"
                                               "111111102010101010101"
                                               "100000102101010101010"
                                               "101110102010101010101"
                                               "101110102101010101010"
                                               "101110102010101010101"
                                               "100000102101010101010"
                                               "111111102010101010101";

    test_applyDataMaskPatternN(0, expected);
}

static void test_applyDataMaskPattern1(void) {
    const uint8_t *expected = (const uint8_t *)"111111102111101111111"
                                               "100000102000001000001"
                                               "101110102111101011101"
                                               "101110102000001011101"
                                               "101110102111101011101"
                                               "100000102000001000001"
                                               "111111101010101111111"
                                               "000000002000000000000"
                                               "222222122111122222222"
                                               "000000000000000000000"
                                               "111111111111111111111"
                                               "000000000000000000000"
                                               "111111111111111111111"
                                               "000000001000000000000"
                                               "111111102111111111111"
                                               "100000102000000000000"
                                               "101110102111111111111"
                                               "101110102000000000000"
                                               "101110102111111111111"
                                               "100000102000000000000"
                                               "111111102111111111111";

    test_applyDataMaskPatternN(1, expected);
}

static void test_applyDataMaskPattern2(void) {
    const uint8_t *expected = (const uint8_t *)"111111102100101111111"
                                               "100000102100101000001"
                                               "101110102100101011101"
                                               "101110102100101011101"
                                               "101110102100101011101"
                                               "100000102100101000001"
                                               "111111101010101111111"
                                               "000000002100100000000"
                                               "222222122100122222222"
                                               "100100000100100100100"
                                               "100100100100100100100"
                                               "100100000100100100100"
                                               "100100100100100100100"
                                               "000000001100100100100"
                                               "111111102100100100100"
                                               "100000102100100100100"
                                               "101110102100100100100"
                                               "101110102100100100100"
                                               "101110102100100100100"
                                               "100000102100100100100"
                                               "111111102100100100100";

    test_applyDataMaskPatternN(2, expected);
}

static void test_applyDataMaskPattern3(void) {
    const uint8_t *expected = (const uint8_t *)"111111102100101111111"
                                               "100000102001001000001"
                                               "101110102010001011101"
                                               "101110102100101011101"
                                               "101110102001001011101"
                                               "100000102010001000001"
                                               "111111101010101111111"
                                               "000000002001000000000"
                                               "222222122010022222222"
                                               "100100000100100100100"
                                               "001001101001001001001"
                                               "010010010010010010010"
                                               "100100100100100100100"
                                               "000000001001001001001"
                                               "111111102010010010010"
                                               "100000102100100100100"
                                               "101110102001001001001"
                                               "101110102010010010010"
                                               "101110102100100100100"
                                               "100000102001001001001"
                                               "111111102010010010010";

    test_applyDataMaskPatternN(3, expected);
}

static void test_applyDataMaskPattern4(void) {
    const uint8_t *expected = (const uint8_t *)"111111102000101111111"
                                               "100000102000101000001"
                                               "101110102111001011101"
                                               "101110102111001011101"
                                               "101110102000101011101"
                                               "100000102000101000001"
                                               "111111101010101111111"
                                               "000000002111000000000"
                                               "222222122000122222222"
                                               "111000011000111000111"
                                               "000111100111000111000"
                                               "000111000111000111000"
                                               "111000111000111000111"
                                               "000000001000111000111"
                                               "111111102111000111000"
                                               "100000102111000111000"
                                               "101110102000111000111"
                                               "101110102000111000111"
                                               "101110102111000111000"
                                               "100000102111000111000"
                                               "111111102000111000111";

    test_applyDataMaskPatternN(4, expected);
}

static void test_applyDataMaskPattern5(void) {
    const uint8_t *expected = (const uint8_t *)"111111102111101111111"
                                               "100000102000101000001"
                                               "101110102100101011101"
                                               "101110102010101011101"
                                               "101110102100101011101"
                                               "100000102000101000001"
                                               "111111101010101111111"
                                               "000000002000100000000"
                                               "222222122100122222222"
                                               "101010001010101010101"
                                               "100100100100100100100"
                                               "100000000000100000100"
                                               "111111111111111111111"
                                               "000000001000100000100"
                                               "111111102100100100100"
                                               "100000102010101010101"
                                               "101110102100100100100"
                                               "101110102000100000100"
                                               "101110102111111111111"
                                               "100000102000100000100"
                                               "111111102100100100100";

    test_applyDataMaskPatternN(5, expected);
}

static void test_applyDataMaskPattern6(void) {
    const uint8_t *expected = (const uint8_t *)"111111102111101111111"
                                               "100000102000101000001"
                                               "101110102110101011101"
                                               "101110102010101011101"
                                               "101110102101101011101"
                                               "100000102011101000001"
                                               "111111101010101111111"
                                               "000000002000100000000"
                                               "222222122110122222222"
                                               "101010001010101010101"
                                               "101101101101101101101"
                                               "100011000011100011100"
                                               "111111111111111111111"
                                               "000000001000111000111"
                                               "111111102110110110110"
                                               "100000102010101010101"
                                               "101110102101101101101"
                                               "101110102011100011100"
                                               "101110102111111111111"
                                               "100000102000111000111"
                                               "111111102110110110110";

    test_applyDataMaskPatternN(6, expected);
}

static void test_applyDataMaskPattern7(void) {
    const uint8_t *expected = (const uint8_t *)"111111102010101111111"
                                               "100000102111001000001"
                                               "101110102011101011101"
                                               "101110102101001011101"
                                               "101110102000101011101"
                                               "100000102100001000001"
                                               "111111101010101111111"
                                               "000000002111000000000"
                                               "222222122011122222222"
                                               "010101010101010101010"
                                               "111000111000111000111"
                                               "011100011100011100011"
                                               "101010101010101010101"
                                               "000000001111000111000"
                                               "111111102011100011100"
                                               "100000102101010101010"
                                               "101110102000111000111"
                                               "101110102100011100011"
                                               "101110102010101010101"
                                               "100000102111000111000"
                                               "111111102011100011100";

    test_applyDataMaskPatternN(7, expected);
}

static void test_calculatePenaltyScoreCondition1(void) {
    size_t symbolSize = 21;
    uint8_t *matrix = malloc(symbolSize * symbolSize * sizeof(uint8_t));

    const uint8_t *input;
    input = (const uint8_t *)"111111102000001111111"
                             "100000102000001000001"
                             "101110102000001011101"
                             "101110102000001011101"
                             "101110102000001011101"
                             "100000102000001000001"
                             "111111101010101111111"
                             "000000002000000000000"
                             "222222122000022222222"
                             "000000000000000000000"
                             "000000100000000000000"
                             "000000000000000000000"
                             "000000100000000000000"
                             "000000001000000000000"
                             "111111102000000000000"
                             "100000102000000000000"
                             "101110102000000000000"
                             "101110102000000000000"
                             "101110102000000000000"
                             "100000102000000000000"
                             "111111102000000000000";

    initializeMatrix(matrix, input, symbolSize);

    assert(calculatePenaltyScoreCondition1(matrix, symbolSize) == 476);

    input = (const uint8_t *)"111111102111101111111"
                             "100000102111101000001"
                             "101110102111101011101"
                             "101110102111101011101"
                             "101110102111101011101"
                             "100000102111101000001"
                             "111111101010101111111"
                             "000000002111100000000"
                             "222222122111122222222"
                             "111111011111111111111"
                             "111111111111111111111"
                             "111111011111111111111"
                             "111111111111111111111"
                             "000000001111111111111"
                             "111111102111111111111"
                             "100000102111111111111"
                             "101110102111111111111"
                             "101110102111111111111"
                             "101110102111111111111"
                             "100000102111111111111"
                             "111111102111111111111";

    initializeMatrix(matrix, input, symbolSize);

    assert(calculatePenaltyScoreCondition1(matrix, symbolSize) == 436);

    input = (const uint8_t *)"111111102010101111111"
                             "100000102010101000001"
                             "101110102010101011101"
                             "101110102010101011101"
                             "101110102101001011101"
                             "100000102010101000001"
                             "111111101010101111111"
                             "000000002010100000000"
                             "222222122010122222222"
                             "010101010101010101010"
                             "101010101010101010101"
                             "101010001010101010101"
                             "101010101010101010101"
                             "000000001010101010101"
                             "111111102101010101010"
                             "100000102010101010101"
                             "101110102010101010101"
                             "101110102010101010101"
                             "101110102010101010101"
                             "100000102101010101010"
                             "111111102010101010101";

    initializeMatrix(matrix, input, symbolSize);

    assert(calculatePenaltyScoreCondition1(matrix, symbolSize) == 135);

    printf("test_calculatePenaltyScoreCondition1() passed\n");
}

static void test_calculatePenaltyScoreCondition2(void) {
    size_t symbolSize = 21;
    uint8_t *matrix = malloc(symbolSize * symbolSize * sizeof(uint8_t));

    const uint8_t *input;
    input = (const uint8_t *)"111111102000001111111"
                             "100000102000001000001"
                             "101110102000001011101"
                             "101110102000001011101"
                             "101110102000001011101"
                             "100000102000001000001"
                             "111111101010101111111"
                             "000000002000000000000"
                             "222222122000022222222"
                             "000000000000000000000"
                             "000000100000000000000"
                             "000000000000000000000"
                             "000000100000000000000"
                             "000000001000000000000"
                             "111111102000000000000"
                             "100000102000000000000"
                             "101110102000000000000"
                             "101110102000000000000"
                             "101110102000000000000"
                             "100000102000000000000"
                             "111111102000000000000";

    initializeMatrix(matrix, input, symbolSize);

    assert(calculatePenaltyScoreCondition2(matrix, symbolSize) == 555);

    input = (const uint8_t *)"111111102111101111111"
                             "100000102111101000001"
                             "101110102111101011101"
                             "101110102111101011101"
                             "101110102111101011101"
                             "100000102111101000001"
                             "111111101010101111111"
                             "000000002111100000000"
                             "222222122111122222222"
                             "111111011111111111111"
                             "111111111111111111111"
                             "111111011111111111111"
                             "111111111111111111111"
                             "000000001111111111111"
                             "111111102111111111111"
                             "100000102111111111111"
                             "101110102111111111111"
                             "101110102111111111111"
                             "101110102111111111111"
                             "100000102111111111111"
                             "111111102111111111111";

    initializeMatrix(matrix, input, symbolSize);

    assert(calculatePenaltyScoreCondition2(matrix, symbolSize) == 528);

    input = (const uint8_t *)"111111102010101111111"
                             "100000102010101000001"
                             "101110102010101011101"
                             "101110102010101011101"
                             "101110102010101011101"
                             "100000102010101000001"
                             "111111101010101111111"
                             "000000002010100000000"
                             "222222122010122222222"
                             "010101001010101010101"
                             "010101101010101010101"
                             "010101001010101010101"
                             "010101101010101010101"
                             "000000001010101010101"
                             "111111102010101010101"
                             "100000102010101010101"
                             "101110102010101010101"
                             "101110102010101010101"
                             "101110102010101010101"
                             "100000102010101010101"
                             "111111102010101010101";

    initializeMatrix(matrix, input, symbolSize);

    assert(calculatePenaltyScoreCondition2(matrix, symbolSize) == 36);

    printf("test_calculatePenaltyScoreCondition2() passed\n");
}

static void test_calculatePenaltyScoreCondition3(void) {
    size_t symbolSize = 21;
    uint8_t *matrix = malloc(symbolSize * symbolSize * sizeof(uint8_t));

    const uint8_t *input;
    input = (const uint8_t *)"111111102000001111111"
                             "100000102000001000001"
                             "101110102000001011101"
                             "101110102000001011101"
                             "101110102000001011101"
                             "100000102000001000001"
                             "111111101010101111111"
                             "000000002000000000000"
                             "222222122000022222222"
                             "000000000000000000000"
                             "000000100000000000000"
                             "000000000000000000000"
                             "000000100000000000000"
                             "000000001000000000000"
                             "111111102000000000000"
                             "100000102000000000000"
                             "101110102000000000000"
                             "101110102000000000000"
                             "101110102000000000000"
                             "100000102000000000000"
                             "111111102000000000000";

    initializeMatrix(matrix, input, symbolSize);

    assert(calculatePenaltyScoreCondition3(matrix, symbolSize) == 240);

    input = (const uint8_t *)"111111102111101111111"
                             "100000102111101000001"
                             "101110102111101011101"
                             "101110102111101011101"
                             "101110102111101011101"
                             "100000102111101000001"
                             "111111101010101111111"
                             "000000002111100000000"
                             "222222122111122222222"
                             "111111011111111111111"
                             "111111111111111111111"
                             "111111011111111111111"
                             "111111111111111111111"
                             "000000001111111111111"
                             "111111102111111111111"
                             "100000102111111111111"
                             "101110102111111111111"
                             "101110102111111111111"
                             "101110102111111111111"
                             "100000102111111111111"
                             "111111102111111111111";

    initializeMatrix(matrix, input, symbolSize);

    assert(calculatePenaltyScoreCondition3(matrix, symbolSize) == 0);

    input = (const uint8_t *)"111111102010101111111"
                             "100000102010101000001"
                             "101110102010101011101"
                             "101110102010101011101"
                             "101110102010101011101"
                             "100000102010101000001"
                             "111111101010101111111"
                             "000000002010100000000"
                             "222222122010122222222"
                             "010101001010101010101"
                             "010101101010101010101"
                             "010101001010101010101"
                             "010101101010101010101"
                             "000000001010101010101"
                             "111111102010101010101"
                             "100000102010101010101"
                             "101110102010101010101"
                             "101110102010101010101"
                             "101110102010101010101"
                             "100000102010101010101"
                             "111111102010101010101";

    initializeMatrix(matrix, input, symbolSize);

    assert(calculatePenaltyScoreCondition3(matrix, symbolSize) == 80);

    printf("test_calculatePenaltyScoreCondition3() passed\n");
}

static void test_calculatePenaltyScoreCondition4(void) {
    size_t symbolSize = 21;
    uint8_t *matrix = malloc(symbolSize * symbolSize * sizeof(uint8_t));

    const uint8_t *input;
    input = (const uint8_t *)"111111102000001111111"
                             "100000102000001000001"
                             "101110102000001011101"
                             "101110102000001011101"
                             "101110102000001011101"
                             "100000102000001000001"
                             "111111101010101111111"
                             "000000002000000000000"
                             "222222122000022222222"
                             "000000000000000000000"
                             "000000100000000000000"
                             "000000000000000000000"
                             "000000100000000000000"
                             "000000001000000000000"
                             "111111102000000000000"
                             "100000102000000000000"
                             "101110102000000000000"
                             "101110102000000000000"
                             "101110102000000000000"
                             "100000102000000000000"
                             "111111102000000000000";

    initializeMatrix(matrix, input, symbolSize);

    assert(calculatePenaltyScoreCondition4(matrix, symbolSize) == 50);

    input = (const uint8_t *)"111111102111101111111"
                             "100000102111101000001"
                             "101110102111101011101"
                             "101110102111101011101"
                             "101110102111101011101"
                             "100000102111101000001"
                             "111111101010101111111"
                             "000000002111100000000"
                             "222222122111122222222"
                             "111111011111111111111"
                             "111111111111111111111"
                             "111111011111111111111"
                             "111111111111111111111"
                             "000000001111111111111"
                             "111111102111111111111"
                             "100000102111111111111"
                             "101110102111111111111"
                             "101110102111111111111"
                             "101110102111111111111"
                             "100000102111111111111"
                             "111111102111111111111";

    initializeMatrix(matrix, input, symbolSize);

    assert(calculatePenaltyScoreCondition4(matrix, symbolSize) == 40);

    input = (const uint8_t *)"111111102010101111111"
                             "100000102010101000001"
                             "101110102010101011101"
                             "101110102010101011101"
                             "101110102010101011101"
                             "100000102010101000001"
                             "111111101010101111111"
                             "000000002010100000000"
                             "222222122010122222222"
                             "010101001010101010101"
                             "010101101010101010101"
                             "010101001010101010101"
                             "010101101010101010101"
                             "000000001010101010101"
                             "111111102010101010101"
                             "100000102010101010101"
                             "101110102010101010101"
                             "101110102010101010101"
                             "101110102010101010101"
                             "100000102010101010101"
                             "111111102010101010101";

    initializeMatrix(matrix, input, symbolSize);

    assert(calculatePenaltyScoreCondition4(matrix, symbolSize) == 0);

    printf("test_calculatePenaltyScoreCondition4() passed\n");
}

static void test_applyDataMaskPatternLowestPenaltyScore(void) {
    size_t symbolSize = 21;

    uint8_t *unmasked = malloc(symbolSize * symbolSize * sizeof(uint8_t));
    uint8_t *masked = malloc(symbolSize * symbolSize * sizeof(uint8_t));

    const uint8_t *input = (const uint8_t *)"555555546001045555555"
                                            "544444546011045444445"
                                            "545554546100145455545"
                                            "545554546000145455545"
                                            "545554546111045455545"
                                            "544444546100045444445"
                                            "555555545454545555555"
                                            "444444446101044444444"
                                            "666666566000066666666"
                                            "100001411110000001000"
                                            "101100510001110111011"
                                            "100110400000100011000"
                                            "100011511101110110100"
                                            "444444445111011101000"
                                            "555555546010001000100"
                                            "544444546111011100001"
                                            "545554546100000001000"
                                            "545554546000000000100"
                                            "545554546111110110000"
                                            "544444546100100010010"
                                            "555555546011110110000";

    initializeMatrix(unmasked, input, symbolSize);

    unsigned int pattern =
        applyDataMaskPatternLowestPenaltyScore(masked, unmasked, symbolSize);

    assert(pattern == 0);

    printf("test_applyDataMaskPatternLowestPenaltyScore() passed\n");
}

int main(void) {
    test_applyDataMaskPattern0();
    test_applyDataMaskPattern1();
    test_applyDataMaskPattern2();
    test_applyDataMaskPattern3();
    test_applyDataMaskPattern4();
    test_applyDataMaskPattern5();
    test_applyDataMaskPattern6();
    test_applyDataMaskPattern7();

    test_calculatePenaltyScoreCondition1();
    test_calculatePenaltyScoreCondition2();
    test_calculatePenaltyScoreCondition3();
    test_calculatePenaltyScoreCondition4();

    test_applyDataMaskPatternLowestPenaltyScore();

    return 0;
}
